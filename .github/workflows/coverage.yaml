on: [push, pull_request]

name: Code coverage with grcov

jobs:
  grcov:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
        - ubuntu-latest
        - macOS-latest
        cargo-test-args:
        - "--features=test_proto2-module,test_proto3-module --no-default-features"
        - "--features=compile-time-optimization,test_proto2-module,test_proto3-module --no-default-features"

    steps:
    - name: Checkout sources
      uses: actions/checkout@v3

    - name: Install toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        override: true
        profile: minimal

    - name: Execute tests
      uses: actions-rs/cargo@v1
      with:
        command: test
        args: --all ${{ matrix.cargo-test-args }}
      env:
        CARGO_INCREMENTAL: 0
        RUSTFLAGS: "-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests"

    - name: Gather coverage data
      id: coverage
      uses: actions-rs/grcov@v0.1
      with:
        coveralls-token: ${{ secrets.COVERALLS_TOKEN }}

    - name: Coveralls upload
      uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        parallel: true
        path-to-lcov: ${{ steps.coverage.outputs.report }}

  grcov_finalize:
    runs-on: ubuntu-latest
    needs: grcov
    steps:
    - name: Coveralls finalization
      uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        parallel-finished: true